---
title: "Análise Exploratória - Prosper Marketplace"
author: "Vinicius Ferreira Santos"
date: "27 de março de 2018"
output: html_document
---

Prosper Marketplace
===

> O Prosper Marketplace é o primeiro mercado de empréstimos peer-to-peer dos Estados Unidos, com mais de US $ 7 bilhões em empréstimos financiados. Os mutuários solicitam empréstimos pessoais ao Prosper e os investidores (individuais ou institucionais) podem financiar de US $ 2.000 a US $ 35.000 por solicitação de empréstimo. Os investidores podem considerar as pontuações de crédito, as classificações e as histórias dos tomadores e a categoria do empréstimo. A Prosper cuida do serviço do empréstimo e cobra e distribui os pagamentos dos mutuários e os juros aos investidores.
[Wikipedia](https://en.wikipedia.org/wiki/Prosper_Marketplace)


## Visão Geral sobre os dados
Este conjunto de dados possui 113.937 empréstimos com 81 variáveis em cada um, incluindo o valor, taxa de juros, status do pagamento, receita do mutuário, seu emprego atual, histórico do cartão de crédito e informações sobre seu último pagamento.
Depois de uma rápida análise sobre os dados, resolvi selecionar as variáveis abaixo:


* ListingCreationDate: A data em que a listagem foi criada.
* Term: A duração do empréstimo expressa em meses.
* LoanStatus: O status atual do empréstimo:
    - Cancelled
    - Chargedoff
    - Completed
    - Current
    - Defaulted
    - FinalPaymentInProgress
    - PastDue (O status PastDue será acompanhado por um intervalo de inadimplência.)
* ClosedDate: A data de encerramento é aplicável para os status de empréstimo Cancelled, Completed, Chargedoff e Defaulted
* BorrowerRate: A taxa de juros do Mutuário para este empréstimo.
* LenderYield: O rendimento do credor no empréstimo. O rendimento do credor é igual à taxa de juros do empréstimo menos a taxa de serviço.
* EstimatedReturn: O retorno estimado atribuído à listagem no momento em que foi criado. O retorno estimado é a diferença entre o rendimento efetivo estimado e a taxa de perda estimada. Aplicável para empréstimos originados após julho de 2009.
* ProsperScore: Uma pontuação de risco personalizada criada usando dados históricos do Prosper. A pontuação varia de 1 a 10, sendo 10 a melhor ou a menor pontuação de risco. Aplicável para empréstimos originados após julho de 2009.
* ListingCategory: A categoria da listagem que o mutuário selecionou ao postar sua listagem:
    - 0 - Not Available
    - 1 - Debt Consolidation
    - 2 - Home Improvement
    - 3 - Business
    - 4 - Personal Loan
    - 5 - Student Use
    - 6 - Auto
    - 7- Other
    - 8 - Baby&Adoption
    - 9 - Boat
    - 10 - Cosmetic Procedure
    - 11 - Engagement Ring
    - 12 - Green Loans
    - 13 - Household Expenses
    - 14 - Large Purchases
    - 15 - Medical/Dental
    - 16 - Motorcycle
    - 17 - RV
    - 18 - Taxes
    - 19 - Vacation
    - 20 - Wedding Loans
* BorrowerState: A abreviação de duas letras do estado do endereço do mutuário no momento em que a Listagem foi criada.
* Occupation: A Ocupação selecionada pelo Mutuário no momento em que criou a listagem.
* EmploymentStatus: O status de emprego do mutuário no momento em que eles publicaram a listagem.
* EmploymentStatusDuration: A duração em meses do status de emprego no momento em que a listagem foi criada.
* IsBorrowerHomeowner: Um Mutuário será classificado como proprietário se tiver uma hipoteca em seu perfil de crédito ou fornecer documentação confirmando que é um proprietário.
* FirstRecordedCreditLine: A data em que a primeira linha de crédito foi aberta.
* BankcardUtilization: A porcentagem de crédito rotativo disponível que é utilizada no momento em que o perfil de crédito foi retirado.
* AvailableBankcardCredit: O crédito total disponível através de cartão bancário no momento em que o perfil de crédito foi retirado.
* TradesOpenedLast6Months: Número de negociações abertas nos últimos 6 meses no momento em que o perfil de crédito foi retirado.
* StatedMonthlyIncome: A renda mensal que o mutuário declarou no momento em que a listagem foi criada.
* TotalProsperLoans: Número de empréstimos que o mutuário tinha na Prosper no momento em que eles criaram esta listagem. Esse valor será nulo se o mutuário não tiver empréstimos anteriores.
* OnTimeProsperPayments: Número de pagamentos em tempo, que o mutuário efetuou em empréstimos na Prosper no momento em que criaram esta listagem. Esse valor será nulo se o mutuário não tiver empréstimos anteriores.
* LoanCurrentDaysDelinquent: O número de dias em atraso.
* LoanMonthsSinceOrigination: Número de meses desde a origem do empréstimo.
* LoanOriginalAmount: O montante de originação do empréstimo.
* LoanOriginationDate: A data em que o empréstimo foi originado.
* LoanOriginationQuarter: O trimestre em que o empréstimo foi originado.
* MonthlyLoanPayment: O pagamento do empréstimo mensal programado.
* Investors: O número de investidores que financiaram o empréstimo.
* Recommendations: Número de recomendações que o mutuário tinha no momento em que a listagem foi criada.
* IncomeRange: O intervalo de rendimento do mutuário no momento em que a listagem foi criada.


```{r setup, include=FALSE}
# ================================================== #
#          Load libraries and main dataset           #
# ================================================== #
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(GGally)
library(ggthemes)


loan_data <- read.csv("prosperLoanData.csv", na.strings=c("","NA"))
```



```{r echo=FALSE}
# ================================================== #
#                  Data Munging                      #
# ================================================== #

#Alterando o nome de ListingCategory..numeric. para ListingCategory
names(loan_data)[17]<-paste("ListingCategory")
names(loan_data)[15]<-paste("ProsperRating")

selected_columns <- c("ListingCreationDate","Term","LoanStatus","ClosedDate","BorrowerRate",
                      "LenderYield","EstimatedReturn","ProsperScore",
                      "ListingCategory","BorrowerState", "Occupation","EmploymentStatus","EmploymentStatusDuration",
                      "IsBorrowerHomeowner", "FirstRecordedCreditLine","BankcardUtilization",                                                     "AvailableBankcardCredit","TradesOpenedLast6Months",
                      "StatedMonthlyIncome", "TotalProsperLoans","OnTimeProsperPayments","LoanCurrentDaysDelinquent",
                      "LoanMonthsSinceOrigination","LoanOriginalAmount","LoanOriginationDate","LoanOriginationQuarter",
                      "MonthlyLoanPayment","Investors", "Recommendations", "IncomeRange", "ProsperRating")
#Separando um dataset novo com as colunas selecionadas
selected_loans <- subset(loan_data, select = selected_columns)
selected_loans$LoanOriginationDate <- as.character(selected_loans$LoanOriginationDate)
selected_loans$LoanOriginationDate <- as.Date(selected_loans$LoanOriginationDate, format= "%Y-%m-%d")
selected_loans$YearLoan <- as.numeric(format(
                                      as.Date(selected_loans$ListingCreationDate), 
                                      "%Y"))
#imprimindo informações sobre o dataset
str(selected_loans)
```
Após a criação do novo dataset com as variáveis selecionadas, continuamos com as mesmas 113.937 observações, só que agora distribuídas em 32 variáveis.


## Análise Univariada


Para iniciar a análise, iremos começar pela distribuição do valor original dos empréstimos 
```{r pressure, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = LoanOriginalAmount), data = selected_loans) +
  geom_histogram() + 
  labs(title="Valores dos empréstimos", 
     x = "Valor do Empréstimo",
     y = "Número de registros")

ggplot(aes(x = LoanOriginalAmount), data = selected_loans) +
  geom_histogram() +
  scale_x_continuous(limits = c(0, 15000), breaks = seq(0, 15000, 2500)) + 
  labs(title="Valores dos empréstimos até 25 mil dolares", 
     x = "Valor do Empréstimo",
     y = "Número de registros")

summary(selected_loans$LoanOriginalAmount)
  
```

Como podemos perceber na primeira visualização, a distribuição possui uma assimetria positiva, o que me levou a limitar a segunda visualização até 25000$, a fim de entender melhor a distribuição. Depois dos ajustes, percebemos alguns picos próximos de 5, 10 e 15 mil dolares. Isso é um ponto interessante, porquê percebemos que as pessoas costumam pegar valores próximos de múltiplos de 5. Outro ponto é que como temos uma assimetria positiva, nossa média(8.337) tende a ser maior que a mediana(6.500), o que nos levaria a resultados errados se fôssemos utilizar a média salarial como medida de comparação.


```{r echo=FALSE, message=FALSE, warning=FALSE}
selected_loans.fc_by_IncoreRange <- selected_loans %>%
  group_by(IncomeRange) %>%
  summarise(n = n()) 


ranges <-c("$0", "$1-24,999", "$25,000-49,999", "$50,000-74,999",
                               "$75,000-99,999","$100,000+", "Not employed", "Not displayed")

  ggplot(selected_loans.fc_by_IncoreRange, aes(x = IncomeRange, y = n, label = n)) +
  geom_bar(stat = "identity", fill ="lightgray") +
  scale_x_discrete(limits = ranges) +  
  geom_text(size = 3, position = position_stack(vjust = 0.5)) + 
  theme(legend.position = "bottom", 
          panel.background = element_blank()) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    labs(title="Distribuição da faixa de renda", 
     fill = "Faixa de Renda",
     y="Número de Empréstimos",
     x = "Faixa de Renda")

table(selected_loans$IncomeRange)
```
A grande concentração de renda dos mutuários está entre $25.000 e $49.999 por ano. A grande descoberta aqui são 1.427 mutuários entre os desempregados e os que não possuem renda estarem conseguindo empréstimos. Como ainda não explorei todas as possíveis informações dos dados, acredito que para os desempregados, a explicação seria informações de renda salarial de empregos anteriores, mas para os com renda $0, acredito que em sua maioria são estudantes ou pessoas com boas recomendações.





```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = StatedMonthlyIncome), data = selected_loans) +
  geom_histogram() +
  scale_x_continuous(limits = c(0, quantile(selected_loans$StatedMonthlyIncome, 0.99)),
                     breaks = seq(0, quantile(selected_loans$StatedMonthlyIncome, 0.99), 2500)) +
   labs(title="Renda mensal dos mutuários", 
     x = "Renda mensal",
     y = "Número de registros")

summary(selected_loans$StatedMonthlyIncome)
```
Como já previa, a distribuição da renda mensal possui uma assimetria positiva, com uma concentração próxima de $ 5.000. Para analisar melhor a distribuição, decidir excluir 1% dos dados superiores, mas, antes disso, descobri que um mutuário com uma renda mensal de quase 2 milhões de dolares, solicitou um empréstimo de 4 mil dolares. Acredito que esse mutuário estava interessado em participar como investidor e fez um empréstimo baixo para verificar a lisura do funcionamento da Prosper.




```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(aes(x = LoanStatus, fill = LoanStatus), data = selected_loans) +
  geom_bar() + 
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
   labs(title="Situação dos empréstimos", 
     fill = "Situação",
     y = "Número de registros")

```

Podemos visualizar que a maioria dos dados se encontra com a situação "current", com surpreendentes 56576 empréstimos, que juntos somam $586.174.602 e outros 38074 "Completed" que somam $235.643.536. Temos também alguns mutuários inadimplentes separados em diferentes categorias que, até então, estão dando um calote de $ 126.356.754.




```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = ProsperScore), data = selected_loans) +
  geom_histogram() + 
  scale_x_continuous(limits = c(0,12), breaks =  seq(0, 12, 1))

summary(selected_loans$ProsperScore)
```

O score dos mutuários demonstram algo parecido com uma distribuição normal, mas como o dicionário de dados indica que o valor 10 pode indicar a melhor ou a menor pontuação, não podemos confiar no score sem uma contextualização melhor de quando o 10 significa algo bom ou ruim.

### Adicionando uma nova característica em nossos empréstimos
Como identificamos um grande número de inadimplentes separados em diferentes categorias, será criada a variável "inadimplente", a fim de identificar com mais facilidade um mutuário inadimplente e um bom pagador.

```{r echo=FALSE, message=FALSE, warning=FALSE}
#definindo inadimplente 
selected_loans$inadimplente <- as.factor(ifelse(
                                      selected_loans$LoanStatus == "Defaulted" |
                                      selected_loans$LoanStatus == "Chargedoff" |
                                      selected_loans$LoanStatus == "Past Due (61-90 days)" |
                                      selected_loans$LoanStatus == "Past Due (91-120 days)" |
                                      selected_loans$LoanStatus == "Past Due (>120 days)", 
                                      TRUE, FALSE))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
#recupera dados dos estados dos EUA
map <- map_data("state")
#cria um dataframe com lat, long e abreviação do nome dos estados.
states <- data.frame(state.center, state.abb)
#recupera o nome completo dos estado a partir da abreviação.
selected_loans$stateFullName <- tolower(state.name[match(selected_loans$BorrowerState, state.abb)])
#cria um agrupamento por estado e situação do mutuário
selected_loans.fc_by_state <- selected_loans %>%
  group_by(stateFullName, inadimplente) %>%
  summarise(n = n()) 
  


ggplot() + 
geom_map(data = map, map = map,
              aes(x = long, y = lat, map_id = region)) +
geom_map(data =  subset(selected_loans.fc_by_state, selected_loans.fc_by_state$inadimplente == TRUE), 
              aes(fill = n, map_id = stateFullName),
              map = map) + 
     expand_limits(x = map$long, y = map$lat) +
     coord_map() +
     geom_text(data = states, 
            aes(x = x, y = y, label = state.abb, group = NULL), size = 2) +
  scale_fill_continuous(low='white', high='red') +
  theme(legend.position = "right", 
          panel.background = element_blank()) + 
  labs(subtitle="Estados dos Mutuários", 
       fill = "Número de mutuários",
       y="Latitude", 
       x="Longitude", 
       title="Mapa de Mutuários Inadimplentes")


ggplot() + 
geom_map(data = map, map = map,
          aes(x = long, y = lat, map_id = region)) +
geom_map(data =  subset(selected_loans.fc_by_state, selected_loans.fc_by_state$inadimplente == FALSE), 
              aes(fill = n, map_id = stateFullName),
              map = map) + 
     expand_limits(x = map$long, y = map$lat) +
     coord_map() +
     geom_text(data = states, 
            aes(x = x, y = y, label = state.abb, group = NULL), size = 2) +
  scale_fill_continuous(low='white', high='blue') +
     theme(legend.position = "right", 
          panel.background = element_blank()) +
  labs(subtitle="Estados dos Mutuários", 
       fill = "Número de mutuários",
       y="Latitude", 
       x="Longitude", 
       title="Mapa de Mutuários Bons Pagadores")
```

Aqui podemos visualizar a grande concentração de empréstimos na Califórnia com exatos 12.351 mutuários bons pagadores e 2.366 inadimplentes. Acredito que essa grande concentração é devido a sede da empresa está situada na Califórnia, onde a empresa deve ter focado grandes esforços em marketing no seu início, levando uma grande confiança tanto dos mutuários quanto dos credores. Outra observação importante é que as regiões central e norte do país possuem poucos mutuários, acredito que isso se deve por ser uma região de pouca população, onde grande parte da economia familiar vem da agropecuária. 




```{r echo=FALSE, message=FALSE, warning=FALSE}
selected_loans.fc_by_ListingCategory <- selected_loans %>%
  group_by(ListingCategory) %>%
  summarise(n = n()) 


categories <- c("Not Available", "Debt Consolidation", "Home Improvement", 
                      "Business", "Personal Loan", "Student Use", "Auto", "Other", 
                      "Baby&Adoption", "Boat", "Cosmetic Procedure", 
                      "Engagement Ring", "Green Loans","Household Expenses", 
                      "Large Purchases", "Medical/Dental", "Motorcycle",
                      "RV", "Taxes", "Vacation", "Wedding Loans")



ggplot(selected_loans.fc_by_ListingCategory, aes(x = ListingCategory, y = n, label = n)) +
geom_bar(stat = "identity", fill = "red") +
scale_x_discrete(limits = categories) +  
geom_text(size = 3, position = position_stack(vjust = 0.8)) + 
theme(legend.position = "bottom") + 
  theme(axis.text.x = element_text(angle = 90, vjust = -2.5), axis.ticks = element_blank()) + 
  labs(title="Motivação para adquirir um empréstimo", 
   x = "Motivo do empréstimo",
   y = "Número de registros")
```

A grande maioria dos empréstimos são para consolidação de dívidas. Isso é algo interessante, porquê as pessoas se endividam para pagar outras dívidas, entrando em um círculo vicioso para trocar de credor. Acredito que emprestar dinheiro para alguém com a finalidade de quitar outras dívidas é muito arriscado, se compararmos com "reformas de casa" e "negócios" que se destacam logo em seguida.


## Análise Bivariada


```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(aes(x = StatedMonthlyIncome, fill = inadimplente), data = selected_loans) +
  geom_histogram() +
  scale_x_continuous(limits = c(0, quantile(selected_loans$StatedMonthlyIncome, 0.99)),
                     breaks = seq(0, quantile(selected_loans$StatedMonthlyIncome, 0.99), 2500)) +
  scale_fill_discrete(labels = c("Bom Pagador", "Inadimplente")) +
   labs(title="Renda mensal por situação do mutuário", 
     fill = "Situação",
     y = "Número de registros",
     x = "Renda mensal")

```

Como agora sabemos quando um mutuário está inadimplente, me surgiu uma dúvida de como ficaria a distribuição de renda mensal por situação. Com a visualização acima, fica claro que somente renda mensal alta não faz um mutuário um bom pagador. Outra observação importante é a confirmação de que a concentração de inadimplentes está próximo da moda da distribuição.




```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(aes(x = LoanOriginalAmount, y = EstimatedReturn), 
       data = selected_loans) +
  geom_point(alpha = 1/20, size = 1, position = 'jitter') +
  geom_smooth(method = 'lm', color = 'red') +
  scale_y_continuous(limits = c(0, 0.3), labels = scales::percent) +
   labs(title="Valor do empréstimo por retorno estimado",
        x = "Valor do Empréstimo",
        y = "Retorno Estimado")

with(selected_loans, cor.test(LoanOriginalAmount, EstimatedReturn))

```

Aqui foi uma grande surpresa para mim, encontrei uma correlação negativa de -0.286 quando esperava que o retorno estimado fosse maior para os credores nos grandes empréstimos. Depois de uma pesquisa no site da Prosper, descobrir que os investidores recebem um uma porcentagem maior para os empréstimos de alto risco, sendo assim, acredito que esses retornos mais altos são de transações de alto risco.




```{r echo=FALSE, message=FALSE, warning=FALSE}
poly.formula <- y ~ poly(x, 2)
ggplot(aes(x = LoanOriginalAmount, y = Investors), 
       data = selected_loans) +
  geom_point(alpha = 1/20, size = 1, position = 'jitter') +
  scale_x_log10() +
  geom_smooth(method = "lm",color = 'red',  formula = poly.formula,
              fill=NA, se=TRUE, linetype = 1) +
  labs(title="Valor do empréstimo por número de investidores",
        x = "Valor do Empréstimo (Log 10)",
        y = "Número de Investidores")

with(selected_loans, cor.test(LoanOriginalAmount, Investors))
```

Aqui foi outra surpresa, esperava um crescimento linear entre investidores e valor do empréstimo, mas encontrei algo parecido com um crescimento polinomial. Percebe-se algumas linhas verticais que são explicadas pela correlação positiva fraca de 0.38.



```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(aes(x = LoanStatus, y = LoanOriginalAmount), 
       data = selected_loans) +
  geom_boxplot(aes(fill = LoanStatus)) + 
  theme( axis.text.x = element_text(angle = 90,hjust = 1, vjust = 0.5)) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "Distribuição da faixa de renda", 
     y = "Valor do Empréstimo",
     fill = "Situação do Empréstimo")

with(selected_loans, by(LoanOriginalAmount, LoanStatus, summary))
```

A maioria das categorias possuem o 1º quartil igual, com algumas exceções. Outra observação interessante é que na maioria das categorias de mutuários inadimplentes, o 3 quartil é maior ou igual a 10 mil dolares.




```{r echo=FALSE, message=FALSE, warning=FALSE}

scores <-c("AA", "A", "B", "C", "D", "E", "HR")

box_vc <- ggplot(aes(x = ProsperRating, y = BorrowerRate, label = ProsperRating), 
       data = selected_loans) +
  geom_boxplot() + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(limits = scores) + 
  theme(legend.position = "bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "Taxa de Juros por Score de Crédito", 
     x = "Score de Crédito",
     y = "Taxa de Juros",
     fill = "Score de Crédito")


#$stats[c(1, 5)] indica que pegará os valores dos quantile do min = 1 até o limite superior do whisker 
# se fosse $stats[c(1, 2)] iria pegar do min até o 1° quantile
vc_ylim2 = boxplot.stats(selected_loans$BorrowerRate)$stats[c(1, 5)]

# define os limites do y baseado no vc_ylim2
c1 = box_vc + coord_cartesian(ylim = vc_ylim2) 


c1

with(selected_loans, by(BorrowerRate, ProsperRating, summary))
```

Na visualização acima podemos perceber um crescimento linear, isso já era algo esperado, porquê a taxa de juros aumenta a medida que o nível de risco também aumenta. Nós também percebemos um IQR muito baixo no nível de risco mais alto(HR). Outra descoberta nessa visualização é que todos os Scores possuem a média e mediana muito próximas, o que nos leva a inferir uma simetria na distribuição.



```{r echo=FALSE, message=FALSE, warning=FALSE}

loans_inadimplentes_by_BankcardUtilization <- group_by(subset(selected_loans, selected_loans$inadimplente == TRUE), ProsperRating)
loans_inadimplentes_mp_by_BankcardUtilization <- summarise(loans_inadimplentes_by_BankcardUtilization, mean_price = mean(BankcardUtilization))

loans_bons_by_BankcardUtilization <- group_by(subset(selected_loans, selected_loans$inadimplente == FALSE), ProsperRating)
loans_bons_mp_by_BankcardUtilization <- summarise(loans_bons_by_BankcardUtilization, mean_price = mean(BankcardUtilization))

p1 <- ggplot(aes(x = ProsperRating, y = mean_price),data = loans_inadimplentes_mp_by_BankcardUtilization) +
        geom_bar(stat = "identity", fill = "#FF7F50") +
        scale_x_discrete(limits = scores) + 
        scale_y_continuous(labels = scales::percent) +
        theme(legend.position = "bottom", 
              panel.background = element_blank()) + 
        labs(title = "Média de uso do cartão de crédito de mutuários inadimplentes", 
             y = "Uso cartão de crédito",
             x = "Score de Risco")

p2 <- ggplot(aes(x = ProsperRating, y = mean_price),data = loans_bons_mp_by_BankcardUtilization) +
        geom_bar(stat="identity", fill = "#00CDCD") +
        scale_x_discrete(limits = scores) +
        scale_y_continuous(labels = scales::percent) +
        theme(legend.position = "bottom", 
              panel.background = element_blank()) + 
        labs(title = "Média de uso do cartão de crédito de mutuários bons pagadores", 
             y = "Uso cartão de crédito",
             x = "Score de Risco")

grid.arrange(p1, p2, ncol = 1)

```

Na visualização acima examinei a média de uso do cartão de crédito por score de risco. Podemos perceber uma tendência entre as duas variáveis, o uso do cartão de crédito aumenta na medida que o score de risco do mutuário também aumenta. Os mutuários de maior risco utilizam em média mais de 50% do crédito rotativo disponível nos cartões, mas identificamos que essa tendência ocorre tanto para os inadimplente quanto para os bons pagadores.

## Análise Multivariada




```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = LoanCurrentDaysDelinquent, y = BankcardUtilization, color = EmploymentStatus), 
       data = subset(selected_loans, !is.na(selected_loans$EmploymentStatus))) +
  geom_point(alpha = 1/10, size = 1, position = 'jitter') +
  scale_y_log10(labels = scales::percent) +
  scale_color_brewer(palette = "Set1",
                     guide = guide_legend(title = 'Situação do emprego',
                                          override.aes = list(alpha = 1, size = 2))) +
  labs(title="Utilização do cartão de crédito por dias em atraso",
      x = "Dias em Atraso",
      y = "Uso Cartão Crédito (Log 10)")
```

Na visualização acima, eu esperava um crescimento do uso do cartão à medida que os dias em atraso fossem aumentando, mas muitos mutuários quando se tornam inadimplentes, já estão com o limite do cartão estourado. Percebemos que os mutuários que mais utilizam o cartão estão empregados, e isso faz bastante sentido, o estranho aqui é que em certo ponto no tempo, a predominância muda de mutuários com o status de "Employed" para "Full-Time". 




```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = LenderYield, fill = inadimplente), 
       data = subset(selected_loans, !is.na(selected_loans$EmploymentStatus))) +
  geom_histogram() +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~ EmploymentStatus, scales = "free") +
  scale_x_continuous(limits = c(0, 0.35), labels = scales::percent) +
  scale_fill_discrete(labels = c("Bom Pagador", "Inadimplente")) +
   labs(title="O rendimento do credor por situação de emprego do mutuário", 
     fill = "Situação",
     y = "Rendimento do credor",
     x = "Uso do cartão de crédito")
```

Decidir investigar o retorno do credor para cada situação de emprego do mutuário e encontrei algumas situações interessantes. Aqui identificamos que todas as situações de emprego possuem um pico elevado na casa dos 30% e os mutuários "Retired" são os únicos que possuem 2 picos consideráveis na casa dos 30%. Os mutuários "Full-time" e "Not available" possuem elevadas parcelas de inadimplentes comparado aos bons pagadores.




```{r echo=FALSE, message=FALSE, warning=FALSE}
gg_color_hue <- function(n) {hcl(h=seq(15, 375, length=n+1), l=65, c=100)[1:n]}

ggplot(aes(x = YearLoan,  y = OnTimeProsperPayments), 
       data = subset(selected_loans, !is.na(OnTimeProsperPayments))) +
  geom_line(aes(color = IncomeRange),
            stat = 'summary', fun.y = median) +
  scale_color_manual(
    "Faixa de Renda",
    values=c(gg_color_hue(length(unique(selected_loans$IncomeRange))), "orange", "darkred")
  ) +
   labs(title="Pagamentos até o data do vencimento", 
     y = "Pagamentos em dia",
     x = "Ano do pagamento")
```

Podemos visualizar que mesmo no período da crise financeira de 2008, houve um crescimento constante no número de pagamentos em dia, mas logo após o ano de 2010, houve uma queda acentuada nos pagamentos. Outro ponto de interessante é o número de pagamentos crescente entre mutuários desempregados e com renda $0. Aqui poderia ter várias explicações possíveis para isso, mas acredito que estes mutuários devem ter conseguido emprego logo após os empréstimos ou podem ter rendas informais.

## Gráficos finais e sumário.



### Primeira Visualização 

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = YearLoan,  y = LenderYield), 
       data = subset(selected_loans, !is.na(BorrowerState))) +
  geom_line(stat = 'summary', fun.y = median) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ BorrowerState) +
  theme(legend.position = "bottom") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 1), axis.ticks = element_blank()) + 
   labs(title="Rendimentos do credor entre 2006 a 2014 por estado", 
     y = "Rendimentos do credor",
     x = "Ano dos rendimentos") 
```

Na análise univariada visualizamos um mapa demonstrando a concentração mutuários inadimplentes e bons pagadores em seus respectivos estados. Isso me deu curiosidade em saber como seria os rendimentos dos credores separados por estado, para isso, criei a visualização acima. Visualizamos um crescimento constante dos rendimentos na maioria dos estados entre 2006 e 2010, com exceção de alguns estados como Montana(MT) e Novo México(NM), onde estavam diminuindo os rendimentos e depois voltaram a subir em 2010. A explicação desse pico em 2010, acredito estar relacionado com a crise mundial de 2008, onde muitos mutuários ficaram endividados/desempregados e recorreram aos empréstimos, sendo categorizados como mutuários de alto risco. A queda após 2010 deve estar relacionado com a leve melhora da economia, onde muitos investidores que financiavam os empréstimos, encontravam os mutuários já em uma situação financeira/emprego mais estável, o que levava a uma categorização de menor risco e consequentemente menor rendimento.

### Segunda visualização

```{r echo=FALSE, message=FALSE, warning=FALSE}
selected_loans.fc_by_Category_inadimplente <- selected_loans %>%
  group_by(ListingCategory, inadimplente) %>%
  summarise(n = n()) 


ggplot(selected_loans.fc_by_Category_inadimplente, 
       aes(x = ListingCategory, y = n, 
           label = n, fill = inadimplente)) +
  geom_bar(stat = "identity") +
  scale_x_discrete(limits = categories) +  
  scale_y_log10() +
  geom_text(size = 3, 
            position = position_stack(vjust = 0.8)) + 
  scale_fill_discrete(labels = c("Bom Pagador", "Inadimplente")) +
  theme(legend.position = "bottom") + 
  theme(axis.text.x = element_text(angle = 90, vjust = -2.5), 
        axis.ticks = element_blank(), 
        axis.text.y = element_blank()) + 
  labs(title="Motivação para adquirir um empréstimo x Situação do Mutuário", 
   x = "Motivo do empréstimo",
   y = "Número de registros (Log 10)",
   fill = "Situação")

print('Situação de emprego dos mutuários que solicitaram empréstivo para RV')
loans_Rv <- subset(selected_loans, selected_loans$ListingCategory == 17)
table(loans_Rv$EmploymentStatus)
```

Aqui o propósito é identificar a situação do mutuário para cada categoria de solicitação do empréstimo que vimos anteriormente. Eu imaginava encontrar uma categoria que tivesse mais inadimplentes que bons pagadores, mas percebemos que não existe tal situação. O que me chamou mais atenção foi que emprestar dinheiro para (RV) e (boat) é um bom negócio. Com uma pesquisada rápida no google, descobrir que "RV" são aqueles "ônibus casa", isso faz muito sentido, porquê normalmente quem compra esse tipo de veículo está com uma vida financeira estável, o que foi devidamente comprovado na segunda visualização. O item que mais me chamava atenção era "Baby&Adoption", porquê é um momento em que as despesas crescem muito na vida de um casal, mas pelo que vimos, os mutuários dessa categoria são, em grande maioria, bons pagadores.

### Terceira visualização

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(aes(x = LoanOriginalAmount, y = EstimatedReturn, color = ProsperRating), 
       data = subset(selected_loans, !is.na(selected_loans$ProsperRating))) +
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_y_continuous(limits = c(0, 0.3), labels = scales::percent) +
  geom_smooth(method = 'lm', color = 'red') +
  scale_color_brewer(type = 'div',
                     guide = guide_legend(title = 'Score de Risco', reverse = T,
                                          override.aes = list(alpha = 1, size = 2))) +
   labs(title="Retorno Estimado por Montante de Empréstimo",
        x = "Valor do Empréstimo",
        y = "Retorno Estimado")

with(selected_loans, cor.test(LoanOriginalAmount, EstimatedReturn))

```

Como tinha suspeitado na análise bivariada, nossa correlação negativa está diretamente relacionada com a concentração de transações de alto risco próximo ao início do eixo X, o que gera um maior retorno para os investidores. Está relação também se explica na análise univariada, quando vimos que a moda do valor original do emprestimo fica próximo de $ 5.000. Outro fator que pode ser levado em conta é o fato dos investidores não puderem emprestar mais do que 10% do seu patrimônio líquido.

## Reflexão

Analisar o dataset da Prosper foi algo bastante interessante. Navegar entre os 113.937 empréstimos com 81 variáveis foi algo bastante desafiador, por isso  separei 32 variáveis de interesse e mesmo assim não conseguir utilizar todas como deveria. O maior desafio aqui, foi entender todas essas informações sendo um leigo no assunto da área de empréstimos peer-to-peer. Me concentrei em tentar identificar padrões entre mutuários inadimplentes/bons pagadores e os padrões que afetam o rendimento dos credores.

Tive sucesso ao identificar o motivo da queda no retorno estimado dos credores, devido aos investimentos iniciais estarem diretamente relacionado a empréstimos de alto risco. Outra grande descoberta foi um crescimento nos pagamentos em dia durante a crise financeira de 2008, principalmente para mutuários que declararam renda de $0 e desempregados. Além dessas grandes descobertas, fiquei um pouco decepcionado com a relação entre o número investidores e valor do empréstimo. Acreditava que encontraria um crescimento linear, mas achei um crescimento polinomial. A maior surpresa foi quando descobri que um mutuário com uma renda mensal de quase 2 milhões, solicitou um empréstimo de 4 mil dolares.

Acredito que o trabalho foi interessante, com grandes descobertas em varios pontos, mas sei que ficaram alguns pontos sem explicação devido a quantidade de variáveis analisadas, pouco tempo e falta de informações importantes como: estado civil, sexo, situação de emprego do cônjugue, ou seja, informações mais pessois dos mutuários. Para trabalhos futuros, penso em fechar o estudo com as variáveis que não foram exploradas, a fim de desenvolver alguns modelos de regressão para tentar prever quando uma solicitação de empréstimo é um bom investimento.  


## Referências
* https://stackoverflow.com/questions/45107302/error-in-seq-lennrowdata-1-argument-must-be-coercible-to-non-negative-in?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
* https://stackoverflow.com/questions/22458970/how-to-reverse-legend-labels-and-color-so-high-value-starts-downstairs?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
* https://stackoverflow.com/questions/20936840/r-get-longitude-latitude-data-for-cities-and-add-it-to-my-dataframe?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
* https://s3.amazonaws.com/udacity-hosted-downloads/ud651/GeographyOfAmericanMusic.html
* https://s3.amazonaws.com/udacity-hosted-downloads/ud651/AtlanticHurricaneTracking.html
* https://s3.amazonaws.com/content.udacity-data.com/courses/ud651/diamondsExample_2016-05.html
* http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html#Treemap
* https://stackoverflow.com/questions/5411979/state-name-to-abbreviation-in-r?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
* https://stackoverflow.com/questions/6644997/showing-data-values-on-stacked-bar-chart-in-ggplot2?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
* https://www.prosper.com/plp/legal/compliance/
* https://stackoverflow.com/questions/37329074/geom-smooth-and-exponential-fits
* https://www.r-bloggers.com/multiple-legends-for-the-same-aesthetic-2/

